// Calendar
(function(e){e.widget("metro.calendar",{version:"1.0.0",options:{format:"yyyy-mm-dd",multiSelect:!1,startMode:"day",weekStart:METRO_WEEK_START!=undefined?METRO_WEEK_START:0,otherDays:!1,date:new Date,buttons:!0,locale:e.Metro.currentLocale,getDates:function(e){},click:function(e,t){},_storage:[]},_year:0,_month:0,_day:0,_today:new Date,_event:"",_mode:"day",_distance:0,_events:[],_create:function(){var e=this.element;e.data("multiSelect")!=undefined&&(this.options.multiSelect=e.data("multiSelect"));e.data("format")!=undefined&&(this.options.format=e.data("format"));e.data("date")!=undefined&&(this.options.date=new Date(e.data("date")));e.data("locale")!=undefined&&(this.options.locale=e.data("locale"));e.data("startMode")!=undefined&&(this.options.startMode=e.data("startMode"));e.data("weekStart")!=undefined&&(this.options.weekStart=e.data("weekStart"));e.data("otherDays")!=undefined&&(this.options.otherDays=e.data("otherDays"));this._year=this.options.date.getFullYear();this._distance=parseInt(this.options.date.getFullYear())-4;this._month=this.options.date.getMonth();this._day=this.options.date.getDate();this._mode=this.options.startMode;e.data("_storage",[]);this._renderCalendar()},_renderMonth:function(){var t=this._year,n=this._month,r=this._day,i=this._event,s=28;n==1&&(t%100!=0&&t%4==0||t%400==0)&&(s=29);var o=["31",""+s+"","31","30","31","30","31","31","30","31","30","31"],u=o[n],a=(new Date(t,n,1)).getDay(),f,l,c,h;this.element.html("");f=e("<table/>").addClass("bordered");l=e("<tr/>");e("<td/>").addClass("text-center").html("<a class='btn-previous-year' href='#'><i class='icon-previous'></i></a>").appendTo(l);e("<td/>").addClass("text-center").html("<a class='btn-previous-month' href='#'><i class='icon-arrow-left-4'></i></a>").appendTo(l);e("<td/>").attr("colspan",3).addClass("text-center").html("<a class='btn-select-month' href='#'>"+e.Metro.Locale[this.options.locale].months[n]+" "+t+"</a>").appendTo(l);e("<td/>").addClass("text-center").html("<a class='btn-next-month' href='#'><i class='icon-arrow-right-4'></i></a>").appendTo(l);e("<td/>").addClass("text-center").html("<a class='btn-next-year' href='#'><i class='icon-next'></i></a>").appendTo(l);l.addClass("calendar-header").appendTo(f);var p;l=e("<tr/>");for(h=0;h<7;h++)if(!this.options.weekStart)c=e("<td/>").addClass("text-center day-of-week").html(e.Metro.Locale[this.options.locale].days[h+7]).appendTo(l);else{p=h+1;p==7&&(p=0);c=e("<td/>").addClass("text-center day-of-week").html(e.Metro.Locale[this.options.locale].days[p+7]).appendTo(l)}l.addClass("calendar-subheader").appendTo(f);var d=this._month-1;d<0&&(d=11);var v=o[d],m=(this.options.weekStart?a+6:a)%7,g="";l=e("<tr/>");for(h=0;h<m;h++){this.options.otherDays&&(g=v-(m-h-1));c=e("<td/>").addClass("empty").html("<small class='other-day'>"+g+"</small>").appendTo(l)}var y=(this.options.weekStart?a+6:a)%7;for(h=1;h<=u;h++){y%=7;if(y==0){l.appendTo(f);l=e("<tr/>")}c=e("<td/>").addClass("text-center day").html("<a href='#'>"+h+"</a>");t==this._today.getFullYear()&&n==this._today.getMonth()&&this._today.getDate()==h&&c.addClass("today");var b=(new Date(this._year,this._month,h)).format("yyyy-mm-dd");this.element.data("_storage").indexOf(b)>=0&&c.find("a").addClass("selected");c.appendTo(l);y++}var w="";for(h=y+1;h<=7;h++){this.options.otherDays&&(w=h-y);c=e("<td/>").addClass("empty").html("<small class='other-day'>"+w+"</small>").appendTo(l)}l.appendTo(f);if(this.options.buttons){l=e("<tr/>").addClass("calendar-actions");c=e("<td/>").attr("colspan",7).addClass("text-left").html("<button class='button calendar-btn-today small success'>"+e.Metro.Locale[this.options.locale].buttons[0]+"</button>&nbsp;<button class='button calendar-btn-clear small warning'>"+e.Metro.Locale[this.options.locale].buttons[1]+"</button>");c.appendTo(l);l.appendTo(f)}f.appendTo(this.element);this.options.getDates(this.element.data("_storage"))},_renderMonths:function(){var t,n,r,i,s;this.element.html("");t=e("<table/>").addClass("bordered");n=e("<tr/>");e("<td/>").addClass("text-center").html("<a class='btn-previous-year' href='#'><i class='icon-arrow-left-4'></i></a>").appendTo(n);e("<td/>").attr("colspan",2).addClass("text-center").html("<a class='btn-select-year' href='#'>"+this._year+"</a>").appendTo(n);e("<td/>").addClass("text-center").html("<a class='btn-next-year' href='#'><i class='icon-arrow-right-4'></i></a>").appendTo(n);n.addClass("calendar-header").appendTo(t);n=e("<tr/>");s=0;for(i=0;i<12;i++){r=e("<td/>").addClass("text-center month").html("<a href='#' data-month='"+i+"'>"+e.Metro.Locale[this.options.locale].months[i+12]+"</a>");this._month==i&&(new Date).getFullYear()==this._year&&r.addClass("today");r.appendTo(n);if((s+1)%4==0){n.appendTo(t);n=e("<tr/>")}s+=1}t.appendTo(this.element)},_renderYears:function(){var t,n,r,i,s;this.element.html("");t=e("<table/>").addClass("bordered");n=e("<tr/>");e("<td/>").addClass("text-center").html("<a class='btn-previous-year' href='#'><i class='icon-arrow-left-4'></i></a>").appendTo(n);e("<td/>").attr("colspan",2).addClass("text-center").html(this._distance+"-"+(this._distance+11)).appendTo(n);e("<td/>").addClass("text-center").html("<a class='btn-next-year' href='#'><i class='icon-arrow-right-4'></i></a>").appendTo(n);n.addClass("calendar-header").appendTo(t);n=e("<tr/>");s=0;for(i=this._distance;i<this._distance+12;i++){r=e("<td/>").addClass("text-center year").html("<a href='#' data-year='"+i+"'>"+i+"</a>");(new Date).getFullYear()==i&&r.addClass("today");r.appendTo(n);if((s+1)%4==0){n.appendTo(t);n=e("<tr/>")}s+=1}t.appendTo(this.element)},_renderCalendar:function(){switch(this._mode){case"year":this._renderYears();break;case"month":this._renderMonths();break;default:this._renderMonth()}this._initButtons()},_initButtons:function(){var t=this,n=this.element.find("table");if(this._mode=="day"){n.find(".btn-select-month").on("click",function(e){e.preventDefault();e.stopPropagation();t._mode="month";t._renderCalendar()});n.find(".btn-previous-month").on("click",function(e){t._event="eventPrevious";e.preventDefault();e.stopPropagation();t._month-=1;if(t._month<0){t._year-=1;t._month=11}t._renderCalendar()});n.find(".btn-next-month").on("click",function(e){t._event="eventNext";e.preventDefault();e.stopPropagation();t._month+=1;if(t._month==12){t._year+=1;t._month=0}t._renderCalendar()});n.find(".btn-previous-year").on("click",function(e){t._event="eventPrevious";e.preventDefault();e.stopPropagation();t._year-=1;t._renderCalendar()});n.find(".btn-next-year").on("click",function(e){t._event="eventNext";e.preventDefault();e.stopPropagation();t._year+=1;t._renderCalendar()});n.find(".calendar-btn-today").on("click",function(e){t._event="eventNext";e.preventDefault();e.stopPropagation();t.options.date=new Date;t._year=t.options.date.getFullYear();t._month=t.options.date.getMonth();t._day=t.options.date.getDate();t._renderCalendar()});n.find(".calendar-btn-clear").on("click",function(e){e.preventDefault();e.stopPropagation();t.options.date=new Date;t._year=t.options.date.getFullYear();t._month=t.options.date.getMonth();t._day=t.options.date.getDate();t.element.data("_storage",[]);t._renderCalendar()});n.find(".day a").on("click",function(r){r.preventDefault();r.stopPropagation();var i=(new Date(t._year,t._month,parseInt(e(this).html()))).format(t.options.format,null),s=new Date(t._year,t._month,parseInt(e(this).html()));if(t.options.multiSelect){e(this).toggleClass("selected");e(this).hasClass("selected")?t._addDate(i):t._removeDate(i)}else{n.find(".day a").removeClass("selected");e(this).addClass("selected");t.element.data("_storage",[]);t._addDate(i)}t.options.getDates(t.element.data("_storage"));t.options.click(i,s)})}else if(this._mode=="month"){n.find(".month a").on("click",function(n){t._event="eventNext";n.preventDefault();n.stopPropagation();t._month=parseInt(e(this).data("month"));t._mode="day";t._renderCalendar()});n.find(".btn-previous-year").on("click",function(e){t._event="eventPrevious";e.preventDefault();e.stopPropagation();t._year-=1;t._renderCalendar()});n.find(".btn-next-year").on("click",function(e){t._event="eventNext";e.preventDefault();e.stopPropagation();t._year+=1;t._renderCalendar()});n.find(".btn-select-year").on("click",function(e){t._event="eventNext";e.preventDefault();e.stopPropagation();t._mode="year";t._renderCalendar()})}else{n.find(".year a").on("click",function(n){t._event="eventNext";n.preventDefault();n.stopPropagation();t._year=parseInt(e(this).data("year"));t._mode="month";t._renderCalendar()});n.find(".btn-previous-year").on("click",function(e){t._event="eventPrevious";e.preventDefault();e.stopPropagation();t._distance-=10;t._renderCalendar()});n.find(".btn-next-year").on("click",function(e){t._event="eventNext";e.preventDefault();e.stopPropagation();t._distance+=10;t._renderCalendar()})}},_addDate:function(e){var t=this.element.data("_storage").indexOf(e);t<0&&this.element.data("_storage").push(e)},_removeDate:function(e){var t=this.element.data("_storage").indexOf(e);this.element.data("_storage").splice(t,1)},setDate:function(e){var t;e=new Date(e);t=(new Date(e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate())).format("yyyy-mm-dd");this._addDate(t);this._renderCalendar()},getDate:function(e){return(new Date(e!=undefined?this.element.data("_storage")[e]:this.element.data("_storage")[0])).format(this.options.format)},getDates:function(){return this.element.data("_storage")},unsetDate:function(e){var t;e=new Date(e);t=(new Date(e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate())).format("yyyy-mm-dd");this._removeDate(t);this._renderCalendar()},_destroy:function(){},_setOption:function(e,t){this._super("_setOption",e,t)}})})(jQuery);